---
import RexLayout from '@layouts/RexLayout.astro';
import { getLayoutData } from '@helpers/layout';
import { initShopwareSite } from '@components/shopware/helpers/server';
import { CLANG_ID_COOKIE_NAME } from '@helpers/cookies';
import { performRedirects } from '@helpers/redirect';
import ArticleLayout from '@layouts/ArticleLayout.astro';

let { path } = Astro.params;

path ??= '/';

if (path.substring(path.lastIndexOf('/') + 1).includes('.')) {
    // exclude file requests
    return new Response();
}

if (path === 'sitemap.xml' || path === 'robots.txt') {
    return Astro.redirect(`${import.meta.env.PUBLIC_REDAXO_ROOT}/${path}`, 301);
}

const {
    contentType,
    article,
    clangs,
    footerArticle,
    currentClang,
    navigation,
    siteStartArticle,
} = await getLayoutData(Astro, path, 2);
const {
    component: Component,
    data,
    contextInstance,
    sessionContext,
    customer,
    itemId,
    redirect: _redirect,
} = await initShopwareSite(Astro, path ?? '/', currentClang.code ?? '');
Astro.cookies.set(CLANG_ID_COOKIE_NAME, currentClang.id, {
    path: '/',
});

const redirect = await performRedirects(
    contentType,
    currentClang,
    clangs,
    Astro,
);
if (redirect) {
    return redirect;
}

//const popups = await getPopupData(Astro, article.id);
---

<RexLayout
    article={article}
    currentClang={currentClang}
    metadata={contentType.metadata}
    clangs={clangs}
    footerArticle={footerArticle}
    navigation={navigation}
    siteStartArticle={siteStartArticle}
    path={path}
    contextInstance={contextInstance}
    sessionContext={sessionContext}
    customer={customer}
>
    {
        contentType.type === 'article' && (
            <ArticleLayout article={article} clang={currentClang} />
        )
    }
    <!--<PopupsManager {popups} />-->
</RexLayout>
