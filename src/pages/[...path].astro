---
import { GenericRedaxoAdapter } from '../adapters/generic-redaxo-adapter';
import Layout from '@layouts/Layout.astro';
import {
    getAllProperties,
    setArticleId,
    setClangId,
} from '@helpers/properties-management/server-properties';
import WildcardCache from '@helpers/wildcards';
import { RedaxoAdapter } from '@adapters/redaxo';

const { path } = Astro.params;

const redaxoRoot = import.meta.env.REDAXO_ROOT as string;
const redaxoEndpoint = import.meta.env.REDAXO_ENDPOINT as string;

if (path === 'sitemap.xml' || path === 'robots.txt') {
    return Astro.redirect(`${redaxoRoot}/${path}`, 301);
}

RedaxoAdapter.init(redaxoRoot, redaxoEndpoint);

const articlePath = await GenericRedaxoAdapter.getArticleByPath(
    path ?? '/',
    '1',
    {
        clang: true,
    },
);

const clangId = articlePath.clang.id;
await WildcardCache.prepareCache(clangId);
setClangId(Astro, clangId);
setArticleId(Astro, articlePath.id);

const allStates = getAllProperties(Astro);
---

<Layout />
<script define:vars={{ allStates }}>
    //@ts-ignore
    window._states = allStates;
    //@ts-ignore
    window.getState = (key) => {
        //@ts-ignore
        return window._states[key];
    };
</script>
