---
import {
    getCategoryId,
    getClangCode,
    getContext,
    getShopwareInstance,
} from '@helpers/properties-management/server-properties';
import {
    ShopwareApiInstance,
    createInstance,
    getCategoryProducts,
} from '@shopware-pwa/shopware-6-client';
import ProductList from '../utils/ProductList';
import Container from '@utils/grid/Container.astro';
import { getSwCookies } from '../helpers/client';

const productStep = 6;
const context = Astro.cookies.get('context').json();
const contextToken = Astro.cookies.get('sw-context-token').value;
const swLangId = Astro.cookies.get('sw-language-id').value;
//let activeCatId = getCategoryId(Astro);
let activeCatId = Astro.cookies.get('categoryId').value || null;
if (activeCatId == null) {
    activeCatId = context.salesChannel.navigationCategoryId;
}

const contextInstance: ShopwareApiInstance = createInstance({
    endpoint: import.meta.env.SHOPWARE_ENDPOINT,
    accessToken: import.meta.env.SHOPWARE_ACCESS_KEY,
    languageId: swLangId,
    contextToken: contextToken,
});

const productListing = await getCategoryProducts(
    activeCatId,
    {
        p: 1,
        limit: productStep,
        associations: { seoUrls: ['id', 'pathInfo'], categories: ['id'] },
    },
    contextInstance,
);

const clangCode = Astro.cookies.get('clangCode').value || 'de';
Astro.cookies.delete('categoryId');
---

<Container>
    <ProductList
        client:only="preact"
        productStep={productStep}
        productListing={productListing}
        clangCode={clangCode}
    />
</Container>
